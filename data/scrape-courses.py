"""
Scrapes courses for each department from ScheduleBuilder.
"""

import json, re, urllib

# Output JSON file (with extension)
output = 'courses.json'

# Pretty-print JSON output?
pretty = True

# To be updated every semester for re-scraping
url = lambda id: 'https://schedulebuilder.berkeley.edu/explore/department/SP/2015/%d' % id

# Regex for extracting data from ScheduleBuilder department pages
regex = '<li>\s*?<a href="/explore/courses/.*?/(\d*?)">\s*?([\w ]*?)\s*?</a> - (.*?)</li>'
# '<a href="/explore/courses/\w\w/\d\d\d\d/(\d*)">[\s]*([\w ]*)[\s]*</a>'

# Generated using generate-departments.js
departments = [{"id":97,"full":"AEROSPACE STUDIES","code":"AEROSPC","aliases":[]},{"id":1,"full":"AFRICAN AMERICAN STUDIES","code":"AFRICAM","aliases":[]},{"id":71,"full":"AFRIKAANS","code":"AFRKANS","aliases":[]},{"id":2,"full":"AGRICULTURAL AND ENVIRONMENTAL CHEMISTRY","code":"AGR CHM","aliases":[]},{"id":4,"full":"AGRICULTURAL AND RESOURCE ECONOMICS AND POLICY","code":"A,RESEC","aliases":[]},{"id":47,"full":"ALTAIC","code":"ALTAIC","aliases":[]},{"id":5,"full":"AMERICAN STUDIES","code":"AMERSTD","aliases":[]},{"id":6,"full":"ANCIENT HISTORY AND MEDITERRANEAN ARCHAEOLOGY","code":"AHMA","aliases":[]},{"id":7,"full":"ANTHROPOLOGY","code":"ANTHRO","aliases":[]},{"id":8,"full":"APPLIED SCIENCE AND TECHNOLOGY","code":"AST","aliases":[]},{"id":106,"full":"ARABIC","code":"ARABIC","aliases":[]},{"id":9,"full":"ARCHITECTURE","code":"ARCH","aliases":[]},{"id":13,"full":"ASIAN AMERICAN STUDIES","code":"ASAMST","aliases":[]},{"id":14,"full":"ASIAN STUDIES","code":"ASIANST","aliases":[]},{"id":15,"full":"ASTRONOMY","code":"ASTRON","aliases":[]},{"id":142,"full":"BENGALI","code":"BANGLA","aliases":[]},{"id":23,"full":"BERKELEY/COLUMBIA MBA PROGRAM","code":"XMBA","aliases":[]},{"id":16,"full":"BIOENGINEERING","code":"BIO ENG","aliases":["BIOE"]},{"id":159,"full":"BIOLOGY","code":"BIOLOGY","aliases":[]},{"id":17,"full":"BIOPHYSICS","code":"BIOPHY","aliases":[]},{"id":18,"full":"BUDDHIST STUDIES","code":"BUDDSTD","aliases":[]},{"id":154,"full":"CATALAN","code":"CATALAN","aliases":[]},{"id":26,"full":"CELTIC STUDIES","code":"CELTIC","aliases":[]},{"id":27,"full":"CHEMICAL AND BIOMOLECULAR ENGINEERING","code":"CHM ENG","aliases":["CHEME"]},{"id":28,"full":"CHEMISTRY","code":"CHEM","aliases":[]},{"id":29,"full":"CHICANO STUDIES","code":"CHICANO","aliases":[]},{"id":45,"full":"CHINESE","code":"CHINESE","aliases":[]},{"id":30,"full":"CITY AND REGIONAL PLANNING","code":"CY PLAN","aliases":[]},{"id":31,"full":"CIVIL AND ENVIRONMENTAL ENGINEERING","code":"CIV ENG","aliases":["CEE"]},{"id":32,"full":"CLASSICS","code":"CLASSIC","aliases":[]},{"id":35,"full":"COGNITIVE SCIENCE","code":"COG SCI","aliases":[]},{"id":36,"full":"COLLEGE WRITING PROGRAM","code":"COLWRIT","aliases":[]},{"id":37,"full":"COMPARATIVE BIOCHEMISTRY","code":"COMPBIO","aliases":[]},{"id":38,"full":"COMPARATIVE LITERATURE","code":"COM LIT","aliases":[]},{"id":1181,"full":"COMPUTATIONAL BIOLOGY","code":"CMPBIO","aliases":["COMP BIO"]},{"id":53,"full":"COMPUTER SCIENCE","code":"COMPSCI","aliases":["CS"]},{"id":40,"full":"CRITICAL THEORY GRADUATE GROUP","code":"CRIT TH","aliases":[]},{"id":107,"full":"CUNEIFORM","code":"CUNEIF","aliases":[]},{"id":41,"full":"DEMOGRAPHY","code":"DEMOG","aliases":[]},{"id":1183,"full":"DEVELOPMENT ENGINEERING","code":"DEV ENG","aliases":["DEV ENG"]},{"id":1171,"full":"DEVELOPMENT PRACTICE","code":"DEVP","aliases":[]},{"id":42,"full":"DEVELOPMENT STUDIES","code":"DEV STD","aliases":[]},{"id":25,"full":"DOCTORAL PROGRAM IN BUSINESS ADMINISTRATION","code":"PHDBA","aliases":[]},{"id":70,"full":"DUTCH","code":"DUTCH","aliases":[]},{"id":43,"full":"EARTH AND PLANETARY SCIENCE","code":"EPS","aliases":[]},{"id":44,"full":"EAST ASIAN LANGUAGES AND CULTURES","code":"EA LANG","aliases":[]},{"id":135,"full":"EAST EUROPEAN STUDIES","code":"EAEURST","aliases":[]},{"id":50,"full":"ECONOMICS","code":"ECON","aliases":[]},{"id":51,"full":"EDUCATION","code":"EDUC","aliases":[]},{"id":108,"full":"EGYPTIAN","code":"EGYPT","aliases":[]},{"id":52,"full":"ELECTRICAL ENGINEERING","code":"EL ENG","aliases":["EE"]},{"id":54,"full":"ENERGY AND RESOURCES GROUP","code":"ENE,RES","aliases":[]},{"id":55,"full":"ENGINEERING","code":"ENGIN","aliases":["E"]},{"id":56,"full":"ENGLISH","code":"ENGLISH","aliases":[]},{"id":57,"full":"ENVIRONMENTAL DESIGN","code":"ENV DES","aliases":[]},{"id":3,"full":"ENVIRONMENTAL ECONOMICS AND POLICY","code":"ENVECON","aliases":[]},{"id":58,"full":"ENVIRONMENTAL SCIENCE, POLICY, AND MANAGEMENT","code":"ESPM","aliases":[]},{"id":59,"full":"ENVIRONMENTAL SCIENCES","code":"ENV SCI","aliases":[]},{"id":60,"full":"ETHNIC STUDIES","code":"ETH STD","aliases":[]},{"id":61,"full":"ETHNIC STUDIES GRADUATE GROUP","code":"ETH GRP","aliases":[]},{"id":136,"full":"EURASIAN STUDIES","code":"EURA ST","aliases":[]},{"id":22,"full":"EVENING/WEEKEND MBA PROGRAM","code":"EWMBA","aliases":[]},{"id":162,"full":"FILIPINO","code":"FILIPN","aliases":[]},{"id":62,"full":"FILM AND MEDIA","code":"FILM","aliases":[]},{"id":63,"full":"FOLKLORE","code":"FOLKLOR","aliases":[]},{"id":64,"full":"FRENCH","code":"FRENCH","aliases":[]},{"id":21,"full":"FULL-TIME MASTERS IN BUSINESS ADMINISTRATION","code":"MBA","aliases":[]},{"id":65,"full":"GENDER AND WOMEN'S STUDIES","code":"GWS","aliases":[]},{"id":67,"full":"GEOGRAPHY","code":"GEOG","aliases":[]},{"id":68,"full":"GERMAN","code":"GERMAN","aliases":[]},{"id":1170,"full":"GLOBAL METROPOLITAN STUDIES","code":"GMS","aliases":[]},{"id":204,"full":"GLOBAL POVERTY AND PRACTICE","code":"GPP","aliases":[]},{"id":72,"full":"GRADUATE STUDENT PROFESSIONAL DEVELOPMENT PROGRAM","code":"GSPDP","aliases":[]},{"id":33,"full":"GREEK","code":"GREEK","aliases":[]},{"id":74,"full":"HEALTH AND MEDICAL SCIENCES","code":"HMEDSCI","aliases":[]},{"id":109,"full":"HEBREW","code":"HEBREW","aliases":[]},{"id":143,"full":"HINDI-URDU","code":"HIN-URD","aliases":[]},{"id":75,"full":"HISTORY","code":"HISTORY","aliases":[]},{"id":12,"full":"HISTORY OF ART","code":"HISTART","aliases":[]},{"id":155,"full":"INDIGENOUS LANGUAGES OF THE AMERICAS","code":"ILA","aliases":[]},{"id":76,"full":"INDUSTRIAL ENGINEERING AND OPERATIONS RESEARCH","code":"IND ENG","aliases":["IEOR"]},{"id":77,"full":"INFORMATION","code":"INFO","aliases":[]},{"id":78,"full":"INTEGRATIVE BIOLOGY","code":"INTEGBI","aliases":["IB"]},{"id":79,"full":"INTERDISCIPLINARY STUDIES FIELD MAJOR","code":"ISF","aliases":[]},{"id":80,"full":"INTERNATIONAL AND AREA STUDIES","code":"IAS","aliases":[]},{"id":111,"full":"IRANIAN","code":"IRANIAN","aliases":[]},{"id":81,"full":"ITALIAN STUDIES","code":"ITALIAN","aliases":[]},{"id":46,"full":"JAPANESE","code":"JAPAN","aliases":[]},{"id":82,"full":"JEWISH STUDIES","code":"JEWISH","aliases":[]},{"id":83,"full":"JOURNALISM","code":"JOURN","aliases":[]},{"id":144,"full":"KHMER","code":"KHMER","aliases":[]},{"id":48,"full":"KOREAN","code":"KOREAN","aliases":[]},{"id":84,"full":"LANDSCAPE ARCHITECTURE","code":"LD ARCH","aliases":[]},{"id":73,"full":"LANGUAGE PROFICIENCY PROGRAM","code":"LAN PRO","aliases":[]},{"id":34,"full":"LATIN","code":"LATIN","aliases":[]},{"id":85,"full":"LATIN AMERICAN STUDIES","code":"LATAMST","aliases":[]},{"id":86,"full":"LAW","code":"LAW","aliases":[]},{"id":87,"full":"LEGAL STUDIES","code":"LEGALST","aliases":[]},{"id":66,"full":"LESBIAN, GAY, BISEXUAL AND TRANSGENDER STUDIES","code":"LGBT","aliases":[]},{"id":88,"full":"LETTERS AND SCIENCE","code":"L & S","aliases":[]},{"id":89,"full":"LINGUISTICS","code":"LINGUIS","aliases":[]},{"id":145,"full":"MALAY/INDONESIAN","code":"MALAY/I","aliases":[]},{"id":90,"full":"MASS COMMUNICATIONS","code":"MASSCOM","aliases":[]},{"id":24,"full":"MASTERS IN FINANCIAL ENGINEERING PROGRAM","code":"MFE","aliases":[]},{"id":91,"full":"MATERIALS SCIENCE AND ENGINEERING","code":"MAT SCI","aliases":["MSE"]},{"id":92,"full":"MATHEMATICS","code":"MATH","aliases":[]},{"id":93,"full":"MECHANICAL ENGINEERING","code":"MEC ENG","aliases":["ME"]},{"id":160,"full":"MEDIA STUDIES","code":"MEDIAST","aliases":[]},{"id":94,"full":"MEDIEVAL STUDIES","code":"MED ST","aliases":[]},{"id":95,"full":"MIDDLE EASTERN STUDIES","code":"M E STU","aliases":[]},{"id":96,"full":"MILITARY AFFAIRS","code":"MIL AFF","aliases":[]},{"id":98,"full":"MILITARY SCIENCE","code":"MIL SCI","aliases":[]},{"id":100,"full":"MOLECULAR AND CELL BIOLOGY","code":"MCELLBI","aliases":["MCB"]},{"id":101,"full":"MUSIC","code":"MUSIC","aliases":[]},{"id":102,"full":"NANOSCALE SCIENCE AND ENGINEERING","code":"NSE","aliases":[]},{"id":103,"full":"NATIVE AMERICAN STUDIES","code":"NATAMST","aliases":[]},{"id":104,"full":"NATURAL RESOURCES","code":"NAT RES","aliases":[]},{"id":99,"full":"NAVAL SCIENCE","code":"NAV SCI","aliases":[]},{"id":105,"full":"NEAR EASTERN STUDIES","code":"NE STUD","aliases":[]},{"id":114,"full":"NEUROSCIENCE","code":"NEUROSC","aliases":[]},{"id":115,"full":"NEW MEDIA","code":"NWMEDIA","aliases":["CNM"]},{"id":116,"full":"NUCLEAR ENGINEERING","code":"NUC ENG","aliases":["NUCE"]},{"id":117,"full":"NUTRITIONAL SCIENCES AND TOXICOLOGY","code":"NUSCTX","aliases":["NST"]},{"id":118,"full":"OPTOMETRY","code":"OPTOM","aliases":[]},{"id":120,"full":"PEACE AND CONFLICT STUDIES","code":"PACS","aliases":[]},{"id":110,"full":"PERSIAN","code":"PERSIAN","aliases":[]},{"id":121,"full":"PHILOSOPHY","code":"PHILOS","aliases":[]},{"id":122,"full":"PHYSICAL EDUCATION","code":"PHYS ED","aliases":[]},{"id":123,"full":"PHYSICS","code":"PHYSICS","aliases":[]},{"id":124,"full":"PLANT AND MICROBIAL BIOLOGY","code":"PLANTBI","aliases":[]},{"id":125,"full":"POLITICAL ECONOMY","code":"POLECON","aliases":[]},{"id":126,"full":"POLITICAL SCIENCE","code":"POL SCI","aliases":[]},{"id":153,"full":"PORTUGUESE","code":"PORTUG","aliases":[]},{"id":11,"full":"PRACTICE OF ART","code":"ART","aliases":[]},{"id":127,"full":"PSYCHOLOGY","code":"PSYCH","aliases":[]},{"id":128,"full":"PUBLIC HEALTH","code":"PB HLTH","aliases":[]},{"id":129,"full":"PUBLIC POLICY","code":"PUB POL","aliases":[]},{"id":146,"full":"PUNJABI","code":"PUNJABI","aliases":[]},{"id":130,"full":"RELIGIOUS STUDIES","code":"RELIGST","aliases":[]},{"id":131,"full":"RHETORIC","code":"RHETOR","aliases":[]},{"id":147,"full":"SANSKRIT","code":"SANSKR","aliases":[]},{"id":132,"full":"SCANDINAVIAN","code":"SCANDIN","aliases":[]},{"id":133,"full":"SCIENCE AND MATHEMATICS EDUCATION","code":"SCMATHE","aliases":[]},{"id":1182,"full":"SCIENCE AND TECHNOLOGY STUDIES","code":"STS","aliases":["STS"]},{"id":112,"full":"SEMITICS","code":"SEMITIC","aliases":[]},{"id":134,"full":"SLAVIC LANGUAGES AND LITERATURES","code":"SLAVIC","aliases":[]},{"id":137,"full":"SOCIAL WELFARE","code":"SOC WEL","aliases":[]},{"id":138,"full":"SOCIOLOGY","code":"SOCIOL","aliases":[]},{"id":139,"full":"SOUTH AND SOUTHEAST ASIAN STUDIES","code":"S,SEASN","aliases":[]},{"id":140,"full":"SOUTH ASIAN","code":"S ASIAN","aliases":[]},{"id":141,"full":"SOUTHEAST ASIAN","code":"SEASIAN","aliases":[]},{"id":152,"full":"SPANISH","code":"SPANISH","aliases":[]},{"id":156,"full":"STATISTICS","code":"STAT","aliases":["STATS"]},{"id":148,"full":"TAGALOG","code":"TAGALG","aliases":[]},{"id":149,"full":"TAMIL","code":"TAMIL","aliases":[]},{"id":161,"full":"TELUGU","code":"TELUGU","aliases":[]},{"id":150,"full":"THAI","code":"THAI","aliases":[]},{"id":157,"full":"THEATER, DANCE, AND PERFORMANCE STUDIES","code":"THEATER","aliases":[]},{"id":49,"full":"TIBETAN","code":"TIBETAN","aliases":[]},{"id":113,"full":"TURKISH","code":"TURKISH","aliases":[]},{"id":158,"full":"UNDERGRADUATE AND INTERDISCIPLINARY STUDIES","code":"UGIS","aliases":[]},{"id":20,"full":"UNDERGRADUATE BUSINESS ADMINISTRATION","code":"UGBA","aliases":[]},{"id":151,"full":"VIETNAMESE","code":"VIETNMS","aliases":[]},{"id":119,"full":"VISION SCIENCE","code":"VIS SCI","aliases":[]},{"id":10,"full":"VISUAL STUDIES","code":"VIS STD","aliases":[]},{"id":69,"full":"YIDDISH","code":"YIDDISH","aliases":[]}];

numCourses = 0
coursesById = {}  # Grouped by department ID
for department in departments:
    print 'Getting courses in', department['full']
    courses = []
    id = department['id']
    html = urllib.urlopen(url(id)).read()
    matches = re.findall(regex, html, flags=re.DOTALL)
    for match in matches:
        scheduleBuilderId = match[0]
        courseNum = match[1].strip().split(' ')[-1]
        title = match[2].strip()
        numCourses += 1
        courses.append({'sbid': scheduleBuilderId, 'cnum': courseNum, 'title': title})
    coursesById[department['code']] = courses
print 'Scraped %d courses in %d departments' % (numCourses, len(coursesById.keys()))
file = open(output, 'w')
if pretty:
    file.write(json.dumps(coursesById, indent=4, separators=(',', ': ')))
else:
    file.write(json.dumps(coursesById))
file.close()
print 'Saved to', output
